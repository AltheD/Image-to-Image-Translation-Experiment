# 实验日志 2025-12-15

## 背景
- 目标：依据《Guide.md》5.2 数据处理要求，将 Cityscapes 拼接图拆分为 label/photo 对，并生成划分索引。
- 原始数据位置：`data/raw/cityscapes/{train,val}`，拼接图尺寸 512×256（左 photo / 右 label）。

## 操作记录
1. 编写脚本 `src/data/prepare_cityscapes.py`：
   - 功能：批量分割拼接图，输出到 `data/processed/{split}/{photo,label}`；生成划分索引 JSON。
   - 参数：`--raw-dir data/raw/cityscapes --out-dir data/processed --split-file data/splits/cityscapes_split_seed42.json [--overwrite]`。
2. 运行分割：
   - 命令：`python src/data/prepare_cityscapes.py`
   - 输出：`train: 2975 images`, `val: 500 images`。
3. 数据完整性检查（Python 脚本快速验收）：
   - 划分文件计数：train 2975，val 500。
   - 前 100 个样本无缺失（photo/label 均存在）。
   - 随机抽查 6 张：`photo`/`label` 尺寸均 256×256，模式均 RGB（示例：`train/679.jpg`, `val/225.jpg`）。

## 结果摘要
- 生成文件：
  - `data/processed/train/photo` 2975 张 JPG
  - `data/processed/train/label` 2975 张 PNG
  - `data/processed/val/photo` 500 张 JPG
  - `data/processed/val/label` 500 张 PNG
  - 划分索引：`data/splits/cityscapes_split_seed42.json`（仅 train/val，无 test）
- 验证结论：分割与索引正确，未发现缺失或尺寸/通道异常。

## 数据探索（Guide 6.1）
- Notebook 更新：`notebooks/00_data_exploration.ipynb` 新增“模式统计与标签颜色唯一值”单元，支持全量尺寸/模式统计与标签颜色抽样。
- 运行结果（全量统计 + 抽样）：
  - 尺寸/模式：train=2975、val=500，全部 `256×256`；photo/label 模式均为 `RGB`。
  - 标签颜色抽样（3 图/分割，RGB 唯一色数量示例）：train≈1.0–1.8 万色，val≈1.2–1.6 万色，用于确认标签已为彩色映射。
- 数据质量：未发现缺失/损坏（前述缺失检查与 corruption 检查已覆盖）。
- Notebook 执行与导出：
  - 运行命令：`python -m nbconvert --to notebook --execute notebooks/00_data_exploration.ipynb --output outputs/figures/00_data_exploration_executed.ipynb --ExecutePreprocessor.timeout=600`
  - 产出文件（位于 `outputs/figures/`）：`eda_summary.csv`、`eda_samples_train.png`、`eda_samples_val.png`
  - 执行后的 notebook 存放：`notebooks/outputs/figures/00_data_exploration_executed.ipynb`（nbconvert 默认相对 notebooks/）

## 输入归一化与数据加载（Guide 6.2）
- 新增 `src/data/transforms.py`：提供 `build_transform(image_size, jitter, normalize_mode)`，支持
  - 尺寸统一（默认 256），随机 jitter（286 → 随机裁 256），随机水平翻转。
  - photo 归一化模式：`tanh` → [-1,1]；`01` → [0,1]。label 仅做 [0,1] 标准化。
- 新增 `src/data/dataset.py`：`CityscapesDataset` 读取 `data/processed/{split}/{photo,label}`，使用划分文件 `data/splits/cityscapes_split_seed42.json`，可插入任意 transform(label, photo)。
- 建议调用示例：
  ```python
  from src.data.dataset import CityscapesDataset
  from src.data.transforms import build_transform
  ds = CityscapesDataset(
      root=Path("data"),
      split="train",
      split_index=Path("data/splits/cityscapes_split_seed42.json"),
      transform=build_transform(image_size=256, jitter=True, normalize_mode="tanh"),
  )
  ```

## 后续建议
- 如需重跑或覆盖：`python src/data/prepare_cityscapes.py --overwrite`
- 后续任务：接入 `CityscapesDataset` 数据加载器与 transforms，同步使用 `data/splits/cityscapes_split_seed42.json`。

